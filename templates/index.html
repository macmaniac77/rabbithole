<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.16/marked.min.js"></script>
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --bg-primary: #1b2b34;
        --bg-secondary: #22303b;
        --bg-tertiary: #2a3f4a;
        --text-primary: #d1e8e2;
        --text-secondary: #a7c4bc;
        --accent: #66d9ef;
        --hover-bg: #344752;
        --link-color: #66d9ef; /* New link color */
        --link-hover-color: #8be9fd; /* Slightly lighter for hover */
        --link-visited-color: #50b7c1; /* Different shade for visited links */
        --transition-speed: 0.3s;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', Arial, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
    }

    /* Sidebar Styles */
    #sidebar {
        width: 280px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background-color: var(--bg-secondary);
        padding: 20px;
        overflow-y: auto;
        transition: all var(--transition-speed);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    #sidebar.collapsed {
        width: 60px;
        padding: 20px 10px;
    }

    #sidebar.collapsed h2 {
        font-size: 0;
        border: none;
        margin-bottom: 30px;
    }

    #sidebar.collapsed h2::after {
        content: "üìë";
        font-size: 24px;
        display: block;
        text-align: center;
    }

    #toggle-sidebar {
        position: absolute;
        right: -12px;
        top: 50%;
        transform: translateY(-50%);
        background-color: var(--accent);
        border: none;
        width: 24px;
        height: 48px;
        border-radius: 0 24px 24px 0;
        cursor: pointer;
        color: var(--bg-primary);
        transition: var(--transition-speed);
        z-index: 10;
    }

    #toggle-sidebar:hover {
        background-color: var(--text-primary);
    }

    #sidebar h2 {
        color: var(--accent);
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid var(--bg-tertiary);
        padding-bottom: 10px;
    }
	#sidebar.collapsed {
		width: 60px;
		padding: 20px 10px;
	}

	#content.expanded {
		margin-left: 60px;
		max-width: calc(100vw - 60px);
	}

	.folder-content {
		display: none;
	}

	.folder-content.expanded {
		display: block;
	}

	.folder-icon.expanded {
		transform: rotate(90deg);
	}

    /* Folder Structure Styles */
    #folder-structure {
        list-style: none;
        padding-left: 0;
    }

    .folder-item,
    .file-item {
        position: relative;
    }

    .folder-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 0;
        user-select: none;
    }

    .folder-header .folder-icon {
        margin-right: 8px;
        transition: transform var(--transition-speed);
    }

    .folder-header .folder-icon.expanded {
        transform: rotate(90deg);
    }

    .folder-name {
        flex-grow: 1;
    }

    .folder-content {
        display: none;
        margin-left: 16px;
    }

    .folder-content.expanded {
        display: block;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 6px 0;
        cursor: pointer;
        margin-left: 24px; /* Indentation */
    }

    .file-item .file-icon {
        margin-right: 8px;
    }

    .file-item.active {
        background-color: var(--hover-bg);
        border-radius: 4px;
    }

    .file-item:hover {
        background-color: var(--hover-bg);
        border-radius: 4px;
    }

    /* Link Styles */
    #document-article a, .user-context-container a { /* Apply to user context links too */
        color: var(--link-color);
        text-decoration: underline;
        transition: color var(--transition-speed);
    }

    #document-article a:visited, .user-context-container a:visited {
        color: var(--link-visited-color);
    }

    #document-article a:hover, .user-context-container a:hover {
        color: var(--link-hover-color);
    }

    /* Content Styles */
    #content {
        flex: 1;
        margin-left: 280px;
        padding: 30px;
        max-width: calc(100vw - 280px);
        transition: all var(--transition-speed);
    }

    #content.expanded {
        margin-left: 60px;
        max-width: calc(100vw - 60px);
    }

    .document-container, .user-context-container {
        background-color: var(--bg-secondary);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .button {
        background-color: var(--accent);
        color: var(--bg-primary);
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all var(--transition-speed);
        margin-top: 15px;
    }
    
    .button-small { 
        padding: 6px 12px;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 217, 239, 0.2);
    }

    .generation-card {
        background-color: var(--bg-tertiary);
        border-radius: 12px;
        padding: 25px;
        margin-top: 30px;
    }

    .generation-card h3 {
        color: var(--accent);
        margin-bottom: 15px;
    }

    .document-header {
        margin-bottom: 15px;
    }

    #document-title {
        margin: 0 0 10px;
        font-size: 2rem;
        color: var(--accent);
    }

    #document-article {
        line-height: 1.6;
        font-size: 1.1rem;
    }

    .article-footer {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--bg-tertiary);
    }

    .stripe-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 999px;
        background-color: var(--accent);
        color: var(--bg-primary);
        text-decoration: none;
        font-weight: 600;
    }

    .content-tools {
        background-color: var(--bg-secondary);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    #content-footer {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 30px;
    }

    .navigator-controls {
        display: flex;
        justify-content: flex-end;
        margin-top: 15px;
    }
	.file-item.active {
		background-color: var(--hover-bg);
		border-radius: 4px;
		color: var(--accent); 
	}
    textarea {
        width: 100%;
        height: 200px;
        background-color: var(--bg-secondary);
        border: 2px solid var(--bg-tertiary);
        border-radius: 6px;
        color: var(--text-primary);
        padding: 12px;
        margin: 10px 0;
        resize: vertical;
        font-family: inherit;
        transition: border-color var(--transition-speed);
    }

    textarea:focus {
        outline: none;
        border-color: var(--accent);
    }

    select {
        width: 100%;
        padding: 10px;
        background-color: var(--bg-secondary);
        border: 2px solid var(--bg-tertiary);
        border-radius: 6px;
        color: var(--text-primary);
        margin: 10px 0;
        cursor: pointer;
    }

    select:focus {
        outline: none;
        border-color: var(--accent);
    }

	#document-article h1, #document-article h2, #document-article h3 {
		font-size: 1.5em; 
		font-weight: bold;
		color: var(--accent);
	}

	#document-article ul, #document-article ol {
		padding-left: 20px; 
		margin-bottom: 1em;
	}

	#document-article li {
		line-height: 1.5;
		font-size: 1.1rem; 
	}

    #document-article p {
        margin-bottom: 1em;
    }

    #document-article code {
        background-color: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Menlo', monospace;
    }

    pre code {
        background-color: var(--bg-tertiary);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
    }
    .user-context-container ul {
        list-style: none;
        padding-left: 0;
    }
    .user-context-container li {
        background-color: var(--bg-tertiary);
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid var(--accent);
    }

    @media (max-width: 768px) {
        #sidebar { transform: translateX(-100%); }
        #sidebar.active { transform: translateX(0); width: 280px; }
        #content { margin-left: 0; max-width: 100vw; }
        #toggle-sidebar { display: none; }
        .menu-toggle {
            display: block; position: fixed; top: 20px; left: 20px;
            z-index: 1001; background-color: var(--accent);
            padding: 10px; border-radius: 4px; cursor: pointer;
        }
    }
</style>

</head>
<body>
    <!-- Sidebar -->
	<div id="sidebar">
		<h2>Documents</h2>
		<button id="toggle-sidebar" onclick="toggleSidebar()">‚ùÆ</button>
		<div id="folder-structure">
			{{ render_folders(structure) }}
		</div>
	</div>

    <!-- Main Content -->
    <div id="content">
        <div class="document-container">
            <div class="document-header">
                <h1 id="document-title">Select a document to view content...</h1>
            </div>
            <article id="document-article">Choose a document from the sidebar to read it here.</article>
            <div class="article-footer">
                <a id="stripe-link" class="stripe-link" href="{{ stripe_checkout_url or 'https://buy.stripe.com' }}" target="_blank" rel="noopener noreferrer">
                    Support this article on Stripe
                </a>
            </div>
            <button id="edit-button" class="button" style="display: none;" onclick="enableEdit()">Edit Document</button>
            <textarea id="user-comment" placeholder="Add a comment to guide the AI..." style="width: 100%; margin-top: 10px;"></textarea>
            <button id="bigger-button" class="button" style="display: none;" onclick="handleAction('bigger')">Bigger</button>
            <button id="deeper-button" class="button" style="display: none;" onclick="handleAction('deeper')">Deeper</button>
            <div id="edit-area" style="display: none;">
                <textarea id="edit-textarea"></textarea>
                <button onclick="saveEdit()" class="button">Save Changes</button>
            </div>
        </div>

        <div id="editor-tools" style="display: none;">
            <div class="user-context-container">
                <h2>Content Network</h2>
                {% if user_context %}
                    <p>User ID: {{ user_context.user_id }}</p>
                    <p>Credits USD: ${{ "%.2f"|format(user_context.credits_usd) }}</p>
                    <p>Credits SAT: {{ user_context.credits_sat }} sats</p>
                    <p>Last Input: {{ user_context.last_input if user_context.last_input else 'None' }}</p>
            
                    <h3>Active ValuePoints</h3>
                    {% if active_vps %}
                        <ul>
                        {% for vp in active_vps %}
                            <li>
                                <strong>{{ vp.title }}</strong> (Type: {{ vp.vp_type }})
                                <br>
                                {% if vp.interface %}
                                    Interface: <a href="#" onclick="loadMarkdown('{{ vp.interface }}', event)">{{ vp.interface }}</a>
                                {% else %}
                                    Interface: N/A
                                {% endif %}
                                {% if vp.price_usd is not none %} | Price: ${{ "%.2f"|format(vp.price_usd) }} {% endif %}
                                {% if vp.price_sat is not none %} | Price: {{ vp.price_sat }} sats {% endif %}
                                <br>
                                {% if vp.expires %} Expires: {{ vp.expires.strftime('%Y-%m-%d %H:%M') }} {% endif %}
                                <br>
                                <button class="button button-small" onclick="completeVP('{{ user_context.user_id }}', '{{ vp.id }}')">Complete VP</button>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p>No active ValuePoints.</p>
                    {% endif %}
                {% else %}
                    <p>No user context loaded.</p>
                {% endif %}
            </div>

            <div class="content-tools">
                <h2>AI Content Tools</h2>
                <div class="generation-card">
                    <h3>Generate/Alter Document</h3>
                    <textarea id="context-text" placeholder="Enter context or instructions here..."></textarea>
                    <label for="operation">Operation:</label>
                    <select id="operation">
                        <option value="alter">Alter Existing Document</option>
                        <option value="generate">Generate New Document</option>
                    </select>
                    <button onclick="generateDocument()" class="button">Execute</button>
                </div>
                <div class="navigator-controls">
                    <button id="back-button" class="button" type="button">Back</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
<script>
    const renderer = new marked.Renderer();
    renderer.link = function(href, title, text) {
        if (href.endsWith('.md')) {
            return `<a href="#" onclick="loadMarkdown('${href}')">${text}</a>`;
        } else {
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        }
    };
    marked.setOptions({ renderer: renderer });

    let currentDocPath = null;
    let rawMarkdownContent = "";  
    let historyStack = [];        
    const netlifyFunctionBase = (window.location.hostname.includes('netlify.app') || window.location.hostname.includes('netlify'))
        ? '/.netlify/functions'
        : '';
    const useNetlifyFunctions = netlifyFunctionBase !== '';

function renderMarkdown(markdown) {
    return marked.parse(markdown);
}

function slugifyTitle(title) {
    const cleaned = title.replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
    return cleaned || 'generated_document';
}

function extractTitleAndBody(markdown) {
    const lines = markdown.split(/\r?\n/);
    const titleIndex = lines.findIndex((line) => line.startsWith('# '));
    if (titleIndex === -1) {
        return { title: 'Untitled document', body: markdown };
    }
    const title = lines[titleIndex].replace(/^#\s+/, '').trim() || 'Untitled document';
    const bodyLines = lines.slice(0, titleIndex).concat(lines.slice(titleIndex + 1));
    return { title, body: bodyLines.join('\n').trim() };
}

function loadMarkdown(docPath, event) {
    if (event) { // Prevent default only if it's a real event
        event.preventDefault(); 
        event.stopPropagation();
    }
    if (currentDocPath && currentDocPath !== docPath) {
        historyStack.push(currentDocPath);
    }
    currentDocPath = docPath;

    const titleEl = document.getElementById('document-title');
    const articleEl = document.getElementById('document-article');
    titleEl.textContent = 'Loading...';
    articleEl.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
    document.querySelectorAll('.file-item').forEach(item => item.classList.remove('active'));
    
    // If the event target is a file-item, add active class. 
    // For VP interface links, there's no direct file-item to activate in the sidebar unless it's also in the tree.
    if (event && event.currentTarget && event.currentTarget.classList.contains('file-item')) {
        event.currentTarget.classList.add('active');
    }
    // If docPath is a UI interface, we might want to highlight a "virtual" item or nothing
    // For now, just loading content.

    const fetchUrl = useNetlifyFunctions
        ? `${netlifyFunctionBase}/viewDocument?path=${encodeURIComponent(docPath)}`
        : `/view_document/${docPath}`;

    fetch(fetchUrl)
        .then(response => response.ok ? response.json() : Promise.reject("Document not found or not a markdown file."))
        .then(data => {
            rawMarkdownContent = data.markdown_content;
            const { title, body } = extractTitleAndBody(rawMarkdownContent);
            titleEl.textContent = title;
            articleEl.innerHTML = useNetlifyFunctions
                ? renderMarkdown(body)
                : renderMarkdown(body);
            rawMarkdownContent = data.markdown_content;  
            display.innerHTML = useNetlifyFunctions ? renderMarkdown(rawMarkdownContent) : data.html_content;  
            document.getElementById('edit-textarea').value = rawMarkdownContent;  
            document.getElementById('edit-button').style.display = 'block';
            document.getElementById('bigger-button').style.display = 'block';
            document.getElementById('deeper-button').style.display = 'block';
            toggleEditorTools(false);
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        })
        .catch(error => {
            titleEl.textContent = 'Document unavailable';
            articleEl.innerHTML = `<p style="color: #ff5f5f;">${error}</p>`;
            document.getElementById('edit-button').style.display = 'none'; // Hide edit for non-docs
            toggleEditorTools(false);
        });
}

function toggleEditorTools(showTools) {
    const editorTools = document.getElementById('editor-tools');
    if (!editorTools) {
        return;
    }
    editorTools.style.display = showTools ? 'block' : 'none';
}

function enableEdit() {
    document.getElementById('edit-area').style.display = 'block';
    document.getElementById('document-article').style.display = 'none';
    document.getElementById('edit-textarea').value = rawMarkdownContent;
    document.getElementById('edit-textarea').focus();
    toggleEditorTools(true);
}

function saveEdit() {
    const newContent = document.getElementById('edit-textarea').value;
    const currentUserId = '{{ user_context.user_id if user_context else "default_user" }}'; // Get from template
    // Make sure currentDocPath is a valid path for editing (not a non-MD interface)
    if (!currentDocPath || !currentDocPath.endsWith('.md')) {
        showNotification('Cannot edit this content type.', 'error');
        return;
    }

    const requestUrl = useNetlifyFunctions ? `${netlifyFunctionBase}/commitFileToGitHub` : '/edit_document';
    const requestBody = useNetlifyFunctions
        ? {
            filePath: currentDocPath,
            content: newContent,
            commitMessage: `Update document: ${currentDocPath}`,
            isUpdate: true,
        }
        : { doc_path: currentDocPath, content: newContent, user_id: currentUserId };
    const requestHeaders = useNetlifyFunctions
        ? { 'Content-Type': 'application/json' }
        : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` };

    fetch(requestUrl, {
        method: 'POST',
        headers: requestHeaders,
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json().then(data => ({ok: response.ok, data})))
    .then(({ok, data}) => {
        if (!ok) throw new Error(data.message || 'Save failed');
        rawMarkdownContent = newContent;  
        loadMarkdown(currentDocPath); 
        document.getElementById('edit-area').style.display = 'none';
        document.getElementById('document-article').style.display = 'block';
        toggleEditorTools(false);
        showNotification(data.message, 'success');
    })
    .catch(error => {
        showNotification(`An error occurred while saving: ${error.message}`, 'error');
    });
}

function handleAction(actionType) {
    if (!currentDocPath) {
        showNotification('Please select a document first.', 'error');
        return;
    }

    const userComment = document.getElementById('user-comment').value;
    const buttonId = `${actionType}-button`;
    const button = document.getElementById(buttonId);
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Processing...';

    fetch('/.netlify/functions/handleAction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            doc_path: currentDocPath,
            action_type: actionType,
            document_path_history: historyStack,
            user_comment: userComment
        })
    })
    .then(response => response.json().then(data => ({ok: response.ok, data})))
    .then(({ok, data}) => {
        if (!ok) throw new Error(data.message || 'Action failed');
        showNotification(data.message, 'success');
        loadMarkdown(currentDocPath);
    })
    .catch(error => {
        showNotification(`An error occurred: ${error.message}`, 'error');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    const toggleBtn = document.getElementById('toggle-sidebar');
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('expanded');
    toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '‚ùØ' : '‚ùÆ';
}
function toggleFolder(element) {
    const folderContent = element.parentElement.querySelector('.folder-content');
    const folderIcon = element.querySelector('.folder-icon');
    folderContent.classList.toggle('expanded');
    folderIcon.classList.toggle('expanded');
}

function generateDocument() {
    const operation = document.getElementById('operation').value;
    const contextText = document.getElementById('context-text').value;
    const currentUserId = '{{ user_context.user_id if user_context else "default_user" }}';
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true; button.textContent = 'Processing...';

    if (useNetlifyFunctions) {
        if (!contextText) {
            showNotification('Please provide context or instructions.', 'error');
            button.disabled = false; button.textContent = originalText;
            return;
        }
        const baseDir = currentDocPath && currentDocPath.includes('/')
            ? currentDocPath.split('/').slice(0, -1).join('/')
            : '';
        const promptText = operation === 'alter' && rawMarkdownContent
            ? `Alter content:\\n\\n${rawMarkdownContent}\\n\\nInstructions:\\n${contextText}`
            : `Generate new document from context:\\n\\n${contextText}`;
        const titlePromptText = operation === 'generate'
            ? `Create a concise, filename-friendly title (max 5 words, no special characters other than underscore) for the following text:\\n\\n${contextText}`
            : null;

        fetch(`${netlifyFunctionBase}/generateContent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt_text: promptText, title_prompt_text: titlePromptText })
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (!ok) throw new Error(data.message || 'Generation failed');
            const generatedContent = data.content;
            if (!generatedContent) throw new Error('No content returned from generation.');

            if (operation === 'alter') {
                return fetch(`${netlifyFunctionBase}/commitFileToGitHub`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath: currentDocPath,
                        content: generatedContent,
                        commitMessage: `Alter document: ${currentDocPath}`,
                        isUpdate: true,
                    })
                });
            }

            const generatedTitle = data.title || 'generated_document';
            const safeTitle = slugifyTitle(generatedTitle);
            const newFilePath = baseDir ? `${baseDir}/${safeTitle}` : safeTitle;
            return fetch(`${netlifyFunctionBase}/commitFileToGitHub`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filePath: newFilePath,
                    content: generatedContent,
                    commitMessage: `Generate document: ${newFilePath}`,
                    isUpdate: false,
                })
            }).then(() => ({ newDocPath: `${newFilePath}.md` }));
        })
        .then((commitResponse) => {
            if (commitResponse && commitResponse.json) {
                return commitResponse.json().then(data => ({ok: commitResponse.ok, data}));
            }
            return { ok: true, data: { doc_path: commitResponse?.newDocPath } };
        })
        .then(({ok, data}) => {
            if (!ok) throw new Error(data.message || 'Commit failed');
            showNotification('Document processed successfully.', 'success');
            if (operation === 'generate') {
                location.reload();
            } else if (currentDocPath) {
                loadMarkdown(currentDocPath);
            }
            document.getElementById('context-text').value = '';
        })
        .catch(error => { showNotification(`An error occurred during generation: ${error.message}`, 'error'); })
        .finally(() => { button.disabled = false; button.textContent = originalText; });
        return;
    }

    fetch('/generate_document', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` },
        body: JSON.stringify({
            doc_path: currentDocPath, 
            operation: operation,
            context_text: contextText,
            user_id: currentUserId // user_id might be redundant if taken from JWT
        })
    })
    .then(response => response.json().then(data => ({ok: response.ok, data})))
    .then(({ok, data}) => {
        if (!ok) throw new Error(data.message || 'Generation failed');
        showNotification(data.message, 'success');
        if (data.doc_path) {
            if (operation === 'generate') { location.reload(); } 
            else { loadMarkdown(data.doc_path); }
        } else {
            if (operation === 'generate') location.reload();
            else if (currentDocPath) loadMarkdown(currentDocPath);
        }
        document.getElementById('context-text').value = '';
    })
    .catch(error => { showNotification(`An error occurred during generation: ${error.message}`, 'error'); })
    .finally(() => { button.disabled = false; button.textContent = originalText; });
}

function goBack() {
    if (historyStack.length > 0) { loadMarkdown(historyStack.pop()); } 
    else { showNotification("No previous document to go back to.", "error"); }
}
window.addEventListener("popstate", (event) => { goBack(); });

document.addEventListener("DOMContentLoaded", () => {
    const backButton = document.getElementById('back-button');
    if (backButton) {
        backButton.addEventListener('click', goBack);
    }

    // Automatically load 'quickstart/index.md' or a default page
    // Check if a specific document is requested via URL hash, e.g. #quickstart/index.md
    const initialDocPath = window.location.hash ? window.location.hash.substring(1) : 'quickstart/index.md';
    if (initialDocPath) {
        loadMarkdown(initialDocPath);
    }
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

document.getElementById('document-article').addEventListener('click', function(event) {
    const target = event.target;
    if (target.tagName === 'A') {
        const href = target.getAttribute('href');
        if (href && href.endsWith('.md')) {
            event.preventDefault(); 
            loadMarkdown(href); 
        } else if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            target.setAttribute('target', '_blank'); 
            target.setAttribute('rel', 'noopener noreferrer'); 
        }
    }
});

if (window.innerWidth <= 768) {
    const menuToggle = document.createElement('button');
    menuToggle.className = 'menu-toggle'; menuToggle.innerHTML = '‚ò∞';
    menuToggle.onclick = () => { document.getElementById('sidebar').classList.toggle('active'); };
    document.body.appendChild(menuToggle);
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    });
}

const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `
    .notification {
        position: fixed; top: 20px; right: 20px;
        background-color: #323232; color: #fff;
        padding: 15px 25px; border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        opacity: 1; transition: opacity 0.5s ease-out;
    }
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
`;
document.head.appendChild(styleSheet);

async function completeVP(userId, vpId) {
    const token = localStorage.getItem('accessToken');
    if (!token) {
        showNotification('You must be logged in to complete a VP.', 'error');
        // Optionally, redirect to a login page or show a login modal
        // window.location.href = '/login.html'; // Example redirect
        return;
    }

    try {
        const response = await fetch('/vp/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // Send JWT token
            },
            // user_id is now taken from JWT on backend, not needed in body.
            body: JSON.stringify({ vp_id: vpId }), 
        });
        const result = await response.json();
        if (response.ok) {
            showNotification('ValuePoint completed: ' + (result.message || 'Success'), 'success');
            window.location.reload(); 
        } else {
            showNotification('Error completing ValuePoint: ' + (result.message || result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Failed to complete VP:', error);
        showNotification('Failed to complete VP. See console for details.', 'error');
    }
}

// --- Auth Token Management (Example) ---
// Store token after login (assuming /login endpoint returns it as { "access_token": "..." })
// fetch('/login', { method: 'POST', body: JSON.stringify({username: 'u', password: 'p'})})
// .then(res => res.json()).then(data => {
//     if (data.access_token) localStorage.setItem('accessToken', data.access_token);
// });

// To logout or clear token:
// localStorage.removeItem('accessToken');

</script>
</body>
</html>
